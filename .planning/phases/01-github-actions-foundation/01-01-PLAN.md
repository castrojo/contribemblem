---
phase: 01-github-actions-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [".github/workflows/update-emblem.yml"]
autonomous: false

must_haves:
  truths:
    - "Workflow runs on weekly schedule without manual trigger"
    - "Workflow can commit files to repository"
    - "Workflow does not trigger itself recursively"
    - "Git commits have proper author attribution"
  artifacts:
    - path: ".github/workflows/update-emblem.yml"
      provides: "Scheduled workflow with safe commit configuration"
      min_lines: 30
      contains: "schedule:"
      contains: "contents: write"
      contains: "git config user.name"
      contains: "[skip ci]"
  key_links:
    - from: ".github/workflows/update-emblem.yml"
      to: "cron schedule trigger"
      via: "on.schedule"
      pattern: "schedule:\\s+-\\s+cron:"
    - from: ".github/workflows/update-emblem.yml"
      to: "git commit capability"
      via: "permissions.contents"
      pattern: "permissions:\\s+contents:\\s+write"
    - from: ".github/workflows/update-emblem.yml"
      to: "loop prevention"
      via: "commit message and path filters"
      pattern: "\\[skip ci\\]|paths-ignore:"
---

<objective>
Create a GitHub Actions workflow that runs weekly on schedule with proper permissions, git configuration, and infinite loop prevention mechanisms.

Purpose: Establish the foundational infrastructure for automated emblem generation. This workflow must run safely without exhausting quotas or triggering permission failures.

Output: A working scheduled workflow file ready to execute generation logic in future phases.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/01-github-actions-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Create GitHub Actions workflow with all safety mechanisms</name>
  <files>.github/workflows/update-emblem.yml</files>
  <action>
Create a GitHub Actions workflow file at `.github/workflows/update-emblem.yml` that implements all four Phase 1 requirements:

**Structure:**
- Name: "Update ContribEmblem Badge"
- Trigger: `on.schedule` with cron `'0 0 * * 0'` (Sunday midnight UTC) - weekly schedule per ACTNS-01
- Trigger: `on.push.paths-ignore` for `.github/workflows/**` and `*.png` - loop prevention defense-in-depth per ACTNS-02
- Permissions: `permissions.contents: write` at workflow level - required for commits per ACTNS-03
- Job: `update-badge` running on `ubuntu-latest`

**Steps:**
1. Checkout with `actions/checkout@v4`
2. Configure git with user.name `"github-actions[bot]"` and user.email `"github-actions[bot]@users.noreply.github.com"` per ACTNS-04
3. Placeholder generation step with echo "TODO: Phase 2-4 will generate emblem here"
4. Create placeholder file `emblem.png.tmp` with `echo "placeholder" > emblem.png.tmp`
5. Check for changes with `git diff --quiet` and set GITHUB_OUTPUT
6. Commit and push if changed with message `"chore: update emblem badge [skip ci]"` - [skip ci] per ACTNS-02

**Why this structure:**
- Cron on Sunday aligns with weekly rotation logic (Phase 3 requirement)
- paths-ignore prevents workflow from triggering on its own commits (defense-in-depth with [skip ci])
- Placeholder generation step allows workflow to be tested immediately without waiting for Phases 2-4
- Conditional commit (only if changed) prevents empty commits
- github-actions[bot] is the standard GitHub Actions bot account

**Reference research patterns:**
- Complete Scheduled Workflow with All Requirements (01-RESEARCH.md:248-297)
- Pattern 1: Scheduled Workflow with Safe Commits (01-RESEARCH.md:47-84)
- Pattern 3: Permissions Configuration (01-RESEARCH.md:113-131)

DO NOT add complexity beyond these 4 requirements. This is foundational infrastructure only.
  </action>
  <verify>
```bash
# Verify file exists
test -f .github/workflows/update-emblem.yml && echo "✓ Workflow file created"

# Verify contains all required elements
grep -q "schedule:" .github/workflows/update-emblem.yml && echo "✓ Schedule trigger"
grep -q "contents: write" .github/workflows/update-emblem.yml && echo "✓ Write permissions"
grep -q "git config user.name" .github/workflows/update-emblem.yml && echo "✓ Git user config"
grep -q "\[skip ci\]" .github/workflows/update-emblem.yml && echo "✓ Loop prevention"
grep -q "paths-ignore:" .github/workflows/update-emblem.yml && echo "✓ Path filters"
```
  </verify>
  <done>
- Workflow file exists at `.github/workflows/update-emblem.yml`
- File contains schedule trigger with weekly cron syntax
- File grants `contents: write` permission
- File configures git user.name and user.email
- Commit message includes `[skip ci]`
- Path filters exclude workflow and generated files
- All Phase 1 requirements (ACTNS-01 through ACTNS-04) implemented
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
GitHub Actions workflow with:
- Weekly schedule (Sunday midnight UTC)
- Loop prevention ([skip ci] + path filters)
- Write permissions (contents: write)
- Git configuration (github-actions[bot])
- Placeholder generation step for testing
  </what-built>
  <how-to-verify>
**Step 1: Commit and push the workflow**
```bash
git add .github/workflows/update-emblem.yml
git commit -m "feat(phase-01): add scheduled workflow foundation

- Weekly schedule on Sunday midnight UTC
- Loop prevention via [skip ci] and path filters
- Write permissions for committing generated files
- Git configuration for proper attribution
- Placeholder generation for testing

Satisfies: ACTNS-01, ACTNS-02, ACTNS-03, ACTNS-04"
git push
```

**Step 2: Trigger workflow manually (since schedule hasn't fired yet)**
```bash
# Enable workflow_dispatch for testing (add to workflow file under 'on:')
# OR wait for Sunday midnight UTC (not practical)
# OR use GitHub CLI to trigger
gh workflow run update-emblem.yml
```

OR via GitHub web UI:
1. Navigate to https://github.com/{username}/contribemblem/actions
2. Click "Update ContribEmblem Badge" workflow
3. Click "Run workflow" button
4. Wait ~30 seconds
5. Check workflow run completes successfully

**Step 3: Verify workflow behavior**

Expected outcomes:
- ✓ Workflow run appears in Actions tab
- ✓ Workflow completes successfully (green checkmark)
- ✓ New commit appears from github-actions[bot] with "[skip ci]" in message
- ✓ Commit contains `emblem.png.tmp` file
- ✓ Workflow did NOT trigger again after bot commit (loop prevention working)
- ✓ No permission errors in workflow logs

**Step 4: Check workflow logs**
Look for:
- Git configuration step succeeded
- Placeholder generation step succeeded
- Commit and push step succeeded (or skipped if no changes)
- No 403 permission errors
- No "Please tell me who you are" git errors

**Critical: Verify loop prevention**
After the bot commits, check Actions tab - there should be NO new workflow run triggered by that commit. This confirms [skip ci] and path filters are working.
  </how-to-verify>
  <resume-signal>
Type "approved" if workflow runs successfully and does not trigger itself.

If issues found, describe the error (permission denied, infinite loop, git config failure, etc.) and I will fix before proceeding.
  </resume-signal>
</task>

</tasks>

<verification>
Run verification commands from Task 1 to confirm all requirements present in workflow file.

After human verification (Task 2), confirm:
- Workflow run visible in GitHub Actions UI
- Workflow completed successfully
- Bot commit created with proper attribution
- No recursive workflow trigger occurred
- No permission or git configuration errors in logs
</verification>

<success_criteria>
Phase 1 complete when all success criteria from ROADMAP.md are satisfied:

1. ✓ Action runs on weekly schedule (cron trigger) without manual intervention
2. ✓ Action commits to repository without triggering itself recursively
3. ✓ Action has write permissions to commit files (no 403 errors)
4. ✓ Git commits include proper author name and email metadata

Verified through:
- Workflow file analysis (automated checks)
- Workflow execution (human verification)
- Bot commit inspection (attribution and [skip ci])
- Actions tab monitoring (no recursive triggers)
</success_criteria>

<output>
After completion, create `.planning/phases/01-github-actions-foundation/01-01-SUMMARY.md` using the summary template.

Include in summary:
- Workflow file location and structure
- Cron schedule details (weekly on Sunday)
- Loop prevention mechanisms ([skip ci] + path filters)
- Permissions granted (contents: write)
- Git configuration used (github-actions[bot])
- Testing results from human verification
- Any edge cases or warnings for future phases
</output>
