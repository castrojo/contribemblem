---
phase: 04-image-generation-with-power-level
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - scripts/generate-badge.js
  - scripts/assets/fonts/Rajdhani-Bold.ttf
  - .github/workflows/update-emblem.yml
autonomous: true

must_haves:
  truths:
    - "800x400px PNG badge generated with emblem background"
    - "Power Level displayed prominently in top-right corner with gold color"
    - "Individual stats visible with icons in horizontal row"
    - "Text readable on any emblem background (contrast techniques applied)"
    - "Generated badge.png saved to repository root"
  artifacts:
    - path: "package.json"
      provides: "node-canvas dependency declaration"
      contains: "canvas"
    - path: "scripts/generate-badge.js"
      provides: "Badge generation with Destiny-styled overlays"
      min_lines: 80
      exports: []
    - path: "scripts/assets/fonts/Rajdhani-Bold.ttf"
      provides: "Geometric sans-serif font matching Destiny UI"
      min_lines: 1
    - path: "badge.png"
      provides: "Generated emblem badge with stats overlay"
      min_lines: 1
  key_links:
    - from: ".github/workflows/update-emblem.yml"
      to: "scripts/generate-badge.js"
      via: "node command execution"
      pattern: "node scripts/generate-badge\\.js"
    - from: "scripts/generate-badge.js"
      to: "data/stats.json"
      via: "fs.readFileSync"
      pattern: "readFileSync.*stats\\.json"
    - from: "scripts/generate-badge.js"
      to: "data/emblem.jpg"
      via: "canvas.loadImage"
      pattern: "loadImage.*emblem\\.jpg"
---

<objective>
Generate Destiny 2-styled badge PNG compositing emblem artwork with GitHub contribution stats overlay, featuring prominent Power Level display in authentic Destiny design language.

Purpose: Transform Phase 2 stats and Phase 3 emblem into production-ready badge image that visually matches Destiny's character screen aesthetic.

Output: 800x400px PNG badge with multi-layer text rendering for contrast, geometric fonts, and deterministic generation ready for GitHub embedding.
</objective>

<execution_context>
@~/.config/opencode/agents/gsd-planner.md
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-image-generation-with-power-level/04-CONTEXT.md
@.planning/phases/04-image-generation-with-power-level/04-RESEARCH.md
@.planning/phases/02-github-stats-collection/02-01-SUMMARY.md
@.planning/phases/03-bungie-api-integration/03-01-SUMMARY.md
@.github/workflows/update-emblem.yml
@data/emblem-config.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Node.js with node-canvas and download Rajdhani font</name>
  <files>
    package.json
    package-lock.json
    scripts/assets/fonts/Rajdhani-Bold.ttf
  </files>
  <action>
Create package.json with node-canvas 2.11+ dependency (no frameworks, pure Node.js).

Initialize package.json:
```json
{
  "name": "contribemblem-generator",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "dependencies": {
    "canvas": "^2.11.0"
  }
}
```

Run npm install to generate package-lock.json.

Download Rajdhani Bold font from Google Fonts (OFL license, redistribution allowed):
- Create directory: scripts/assets/fonts/
- Download Rajdhani-Bold.ttf from https://github.com/google/fonts/raw/main/ofl/rajdhani/Rajdhani-Bold.ttf
- Verify file size is reasonable (>20KB, indicates successful download)

Context decisions specify:
- Geometric sans-serif matching Destiny UI fonts → Rajdhani Bold is research recommendation
- Font must be registered before canvas creation → will be used in Task 2
- No additional dependencies beyond node-canvas (keep it simple)
  </action>
  <verify>
- `test -f package.json && grep -q '"canvas"' package.json`
- `test -f package-lock.json`
- `test -f scripts/assets/fonts/Rajdhani-Bold.ttf && [ $(stat -c%s scripts/assets/fonts/Rajdhani-Bold.ttf) -gt 20000 ]`
- `node -e "require('canvas'); console.log('✓ node-canvas loads successfully')"`
  </verify>
  <done>
package.json exists with canvas dependency, package-lock.json generated, Rajdhani-Bold.ttf downloaded to scripts/assets/fonts/, node-canvas successfully loads without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement badge generation script with multi-layer text rendering</name>
  <files>
    scripts/generate-badge.js
  </files>
  <action>
Create scripts/generate-badge.js implementing Destiny 2-styled badge generation with exact visual fidelity to context requirements.

**Core requirements from CONTEXT.md:**
1. Power Level top-right corner (sum of 5 metrics), gold color (#F4D03F)
2. Individual stats horizontal row at bottom with symbolic icons (●◆■▲★)
3. Multi-layer text rendering: shadow → stroke → fill (copy Destiny's exact approach)
4. 800x400px canvas, emblem fills entire background
5. K/M number formatting for large values

**Implementation structure:**

```javascript
import { createCanvas, loadImage, registerFont } from 'canvas';
import fs from 'fs/promises';
import { fileURLToPath } from 'url';
import path from 'path';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Register font BEFORE any canvas operations
registerFont(path.join(__dirname, 'assets/fonts/Rajdhani-Bold.ttf'), { 
  family: 'Rajdhani',
  weight: 'bold'
});

// Multi-layer text rendering for contrast (Pattern 1 from RESEARCH.md)
function renderContrastText(ctx, text, x, y, options = {}) {
  const {
    fontSize = 48,
    fontFamily = 'Rajdhani',
    strokeWidth = 4,
    shadowBlur = 10,
    fillColor = '#FFFFFF',
    strokeColor = '#000000',
    shadowColor = 'rgba(0, 0, 0, 0.8)'
  } = options;

  ctx.font = `bold ${fontSize}px ${fontFamily}`;
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';

  // Layer 1: Shadow (outer glow)
  ctx.shadowColor = shadowColor;
  ctx.shadowBlur = shadowBlur;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 2;
  ctx.fillStyle = strokeColor;
  ctx.fillText(text, x, y);

  // Layer 2: Stroke (outline)
  ctx.shadowColor = 'transparent';
  ctx.shadowBlur = 0;
  ctx.strokeStyle = strokeColor;
  ctx.lineWidth = strokeWidth;
  ctx.lineJoin = 'round';
  ctx.strokeText(text, x, y);

  // Layer 3: Fill (main text)
  ctx.fillStyle = fillColor;
  ctx.fillText(text, x, y);
}

// K/M number formatting (Pattern 4 from RESEARCH.md)
function formatNumber(num) {
  if (num >= 1000000) {
    return (num / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
  }
  if (num >= 1000) {
    return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
  }
  return num.toString();
}

async function generateBadge() {
  // 1. Load input data (Phase 2 stats, Phase 3 emblem)
  const statsPath = path.join(__dirname, '../data/stats.json');
  const emblemPath = path.join(__dirname, '../data/emblem.jpg');
  
  const statsData = JSON.parse(await fs.readFile(statsPath, 'utf-8'));
  const emblemImage = await loadImage(emblemPath);
  
  // 2. Calculate Power Level (sum of 5 metrics)
  const powerLevel = 
    statsData.commits + 
    statsData.pull_requests + 
    statsData.issues + 
    statsData.reviews + 
    statsData.stars_received;
  
  // 3. Create canvas and draw emblem background
  const canvas = createCanvas(800, 400);
  const ctx = canvas.getContext('2d');
  
  // Draw emblem filling entire canvas (CONTEXT requirement)
  ctx.drawImage(emblemImage, 0, 0, 800, 400);
  
  // 4. Render Power Level (top-right corner, Destiny exotic gold)
  renderContrastText(ctx, powerLevel.toString(), 700, 80, {
    fontSize: 72,
    fontFamily: 'Rajdhani',
    strokeWidth: 6,
    shadowBlur: 12,
    fillColor: '#F4D03F',  // Destiny exotic gold from RESEARCH.md
    strokeColor: '#000000'
  });
  
  // Render "POWER" label below number
  renderContrastText(ctx, 'POWER', 700, 130, {
    fontSize: 18,
    fontFamily: 'Rajdhani',
    strokeWidth: 3,
    fillColor: '#FFFFFF',
    strokeColor: '#000000'
  });
  
  // 5. Render individual stats (horizontal row, bottom)
  const statY = 350;
  const statSpacing = 150;
  const startX = 100;
  
  const statOrder = [
    { key: 'commits', icon: '●', value: statsData.commits },
    { key: 'pull_requests', icon: '◆', value: statsData.pull_requests },
    { key: 'issues', icon: '■', value: statsData.issues },
    { key: 'reviews', icon: '▲', value: statsData.reviews },
    { key: 'stars_received', icon: '★', value: statsData.stars_received }
  ];
  
  statOrder.forEach((stat, i) => {
    const x = startX + (i * statSpacing);
    const value = formatNumber(stat.value);
    
    // Render icon (monochrome, subtle)
    renderContrastText(ctx, stat.icon, x - 15, statY, {
      fontSize: 16,
      strokeWidth: 2,
      fillColor: '#AAAAAA',
      strokeColor: '#000000',
      shadowBlur: 6
    });
    
    // Render value (white, prominent)
    renderContrastText(ctx, value, x + 15, statY, {
      fontSize: 28,
      fontFamily: 'Rajdhani',
      strokeWidth: 4,
      fillColor: '#FFFFFF',
      strokeColor: '#000000',
      shadowBlur: 8
    });
  });
  
  // 6. Save PNG (overwrites previous version with stable filename)
  const outputPath = path.join(__dirname, '../badge.png');
  const buffer = canvas.toBuffer('image/png');
  await fs.writeFile(outputPath, buffer);
  
  console.log(`✓ Badge generated: ${outputPath}`);
  console.log(`  Power Level: ${powerLevel}`);
  console.log(`  Dimensions: 800x400px`);
  console.log(`  Stats: ${statOrder.map(s => `${s.key}=${s.value}`).join(', ')}`);
}

generateBadge().catch(err => {
  console.error('✗ Badge generation failed:', err.message);
  process.exit(1);
});
```

**Key implementation notes:**
- Font registration happens at module load (RESEARCH.md Pitfall 1)
- Multi-layer text uses shadow+stroke+fill simultaneously (CONTEXT requirement: "copy Destiny's exact implementation")
- Text positioning uses textAlign='center' and textBaseline='middle' for consistency (RESEARCH.md Pitfall 3)
- Power Level placement matches "top-right corner (matching Destiny character screen locations exactly)" from CONTEXT.md
- Stat icons are monochrome Unicode symbols matching CONTEXT requirement: "subtle, monochrome icons"
- Number formatting with K/M abbreviation as specified in CONTEXT.md
- Deterministic generation: same inputs → same PNG output (STATE.md concern about consistency)
  </action>
  <verify>
- `test -f scripts/generate-badge.js`
- `grep -q "registerFont.*Rajdhani" scripts/generate-badge.js`
- `grep -q "renderContrastText" scripts/generate-badge.js`
- `grep -q "shadowColor.*shadowBlur.*strokeText.*fillText" scripts/generate-badge.js`
- `grep -q "formatNumber" scripts/generate-badge.js`
- `grep -q "#F4D03F" scripts/generate-badge.js`  # Destiny gold color
- `node scripts/generate-badge.js` (generates badge.png using current data/stats.json and data/emblem.jpg)
- `test -f badge.png && file badge.png | grep -q "PNG image data, 800 x 400"`
  </verify>
  <done>
scripts/generate-badge.js exists with multi-layer text rendering, Destiny-styled Power Level display (top-right, gold), horizontal stat row with icons, K/M formatting, and generates valid 800x400px PNG badge from Phase 2/3 data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate badge generation into workflow and commit result</name>
  <files>
    .github/workflows/update-emblem.yml
  </files>
  <action>
Update .github/workflows/update-emblem.yml to integrate Node.js badge generation step between emblem fetching and commit.

Add after "Log emblem status" step (line ~107):

```yaml
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate badge
        run: node scripts/generate-badge.js
```

Update "Commit and push if changed" step (currently line ~118-123):
- Change `git add emblem.png.tmp` to `git add badge.png`
- Keep commit message as-is: `"chore: update emblem badge [skip ci]"`

**Rationale:**
- setup-node@v4 with cache:'npm' leverages package-lock.json for fast installs (Phase 1 pattern: use built-in Actions features)
- npm ci (not npm install) ensures reproducible builds matching package-lock.json
- Node.js 20 LTS is current stable (matches ubuntu-latest runner availability)
- Badge generation runs after emblem.jpg is ready (Phase 3 dependency satisfied)
- Stats are already available from earlier workflow step (Phase 2 dependency satisfied)
- Conditional commit logic already exists (Phase 1 decision: "only if changes")
- [skip ci] prevents loop (Phase 1 requirement: ACTNS-02)

Verify workflow still respects existing patterns:
- Cache on date key (Phase 2 decision)
- Non-blocking failures where appropriate
- Proper step naming and logging for debugging
  </action>
  <verify>
- `grep -q "setup-node@v4" .github/workflows/update-emblem.yml`
- `grep -q "npm ci" .github/workflows/update-emblem.yml`
- `grep -q "node scripts/generate-badge.js" .github/workflows/update-emblem.yml`
- `grep -q "git add badge.png" .github/workflows/update-emblem.yml`
- Workflow validation: `cd .github/workflows && gh workflow view update-emblem.yml 2>/dev/null || echo "Workflow file syntax valid (gh not authenticated)"`
  </verify>
  <done>
Workflow updated with Node.js setup, npm ci install, badge generation step, and badge.png commit. Integration maintains Phase 1 loop prevention, Phase 2 caching patterns, and Phase 3 emblem dependency order.
  </done>
</task>

</tasks>

<verification>
After task completion, verify Phase 4 success criteria:

1. **IMAGE-01**: Badge.png generated with emblem background and stat overlays
   - Check: `file badge.png` shows "PNG image data, 800 x 400"
   - Check: Visual inspection shows emblem artwork with text overlays

2. **IMAGE-02**: Power Level prominently displayed
   - Check: grep '#F4D03F' in generate-badge.js (Destiny gold color)
   - Check: Power Level fontSize=72 > stat fontSize=28 (prominence)

3. **IMAGE-03**: Individual stats with icons clearly visible
   - Check: All 5 Unicode icons (●◆■▲★) present in generate-badge.js
   - Check: Horizontal layout with statSpacing defined

4. **IMAGE-04**: Text contrast for readability
   - Check: renderContrastText function uses shadowColor + strokeStyle + fillStyle
   - Check: Three-layer rendering (shadow → stroke → fill)

5. **IMAGE-05**: Correct dimensions
   - Check: createCanvas(800, 400) in generate-badge.js
   - Check: Generated badge.png is exactly 800x400px

6. **IMAGE-06**: Stable filename overwrites previous version
   - Check: Output path is '../badge.png' (fixed location)
   - Check: fs.writeFile (not appendFile or unique name)

Run end-to-end test:
```bash
# Simulate workflow with test data
node scripts/generate-badge.js
file badge.png
identify badge.png  # If ImageMagick available: verify dimensions
```
</verification>

<success_criteria>
Phase 4 complete when ALL must_haves satisfied:

**Truths (observable behaviors):**
1. Running `node scripts/generate-badge.js` produces badge.png without errors
2. badge.png is 800x400px PNG with emblem background visible
3. Power Level number visible in top-right corner with gold color
4. Individual stat values and icons visible in horizontal row at bottom
5. Text remains readable when tested on light, dark, and busy emblem backgrounds

**Artifacts (files exist with correct content):**
1. package.json contains "canvas" dependency
2. scripts/generate-badge.js exists with 80+ lines implementing multi-layer text rendering
3. scripts/assets/fonts/Rajdhani-Bold.ttf exists (font file >20KB)
4. badge.png generated and committed to repository root

**Key Links (critical connections work):**
1. Workflow executes `node scripts/generate-badge.js` successfully
2. generate-badge.js reads data/stats.json (Phase 2 output)
3. generate-badge.js loads data/emblem.jpg (Phase 3 output)

**Phase Goal Met:**
Action generates PNG with Destiny-styled stat overlay featuring prominent Power Level display. Badge ready for Phase 5 README injection.
</success_criteria>

<output>
After completion, create `.planning/phases/04-image-generation-with-power-level/04-01-SUMMARY.md` following summary template with:
- Performance metrics (duration, files modified)
- Accomplishments (badge generation capability, Destiny visual fidelity achieved)
- Task commits (atomic commits for each task)
- Tech stack additions (node-canvas, Rajdhani font)
- Patterns established (multi-layer text rendering, K/M formatting)
- Key decisions (font choice, color values, icon style)
- Affects: Phase 5 (badge.png available for README injection)
</output>
